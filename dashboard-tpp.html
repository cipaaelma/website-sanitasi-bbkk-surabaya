<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard TPP</title>

  <!-- Icon & Chart.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f4f7f6;
      --accent:#312E5C;
      --accent-2:#6a62a7;
      --card:#ffffff;
      --muted:#6b6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#222}
    .header{background:var(--accent);color:#fff;padding:14px 24px;
            display:flex;align-items:center;justify-content:space-between;}
    .header img{height:45px}
    .header a{background:#6a62a7;color:white;padding:8px 14px;border-radius:6px;
              text-decoration:none;font-weight:600;display:inline-block;}
    .page-wrapper{display:flex;min-height:calc(100vh - 72px)}

    /* sidebar */
    .sidebar {
        width: 260px;
        background-color: #312E5C;
        color: white;
        min-height: calc(100vh - 75px);
        padding: 20px;
        box-sizing: border-box;
    }
    .sidebar h2 {
        text-align: center;
        border-bottom: 1px solid #6a62a7;
        padding-bottom: 15px;
        margin-top: 0;
        font-size: 1.2em;
    }
    .sidebar ul {list-style-type: none;padding: 0;margin: 0;}
    .sidebar ul li a {
        display: flex;align-items: center;color: #e0e0e0;text-decoration: none;
        padding: 15px 20px;border-radius: 8px;margin-bottom: 5px;
        transition: background-color 0.3s;
    }
    .sidebar ul li a i {margin-right: 15px;width: 20px;text-align: center;}
    .sidebar ul li a:hover {background-color: #4B447A;}
    .sidebar ul li a.active {background-color: #6a62a7;font-weight: bold;}

    .main{flex:1;padding:22px}
    .main-title{text-align:center;color:var(--accent);font-size:1.6rem;margin:6px 0 18px 0}

    /* filter */
    .filter-section{display:flex;flex-wrap:wrap;gap:12px;align-items:end;background:var(--card);
                    padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:18px}
    .filter-group{min-width:160px;flex:1}
    label{display:block;font-weight:600;margin-bottom:6px;color:var(--muted);font-size:0.9rem}
    select,input[type=date]{width:100%;padding:10px;border-radius:8px;border:1px solid #dfe6ea;background:#f7fbff}
    .btn{padding:10px 16px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#6a62a7}

    /* KPI */
    .kpi-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:18px}
    .kpi{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:6px}
    .kpi .title{font-size:0.95rem;color:var(--muted)}
    .kpi .value{font-size:1.6rem;color:var(--accent);font-weight:800}

    /* charts */
    .chart-section{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px}
    .chart-card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);min-height:220px}
    .chart-card h3{margin:0 0 8px 0;color:var(--accent);font-size:1rem}
    .chart-canvas{position:relative;height:220px}
    .chart-full{grid-column:1/-1}

    /* table */
    .table-card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef2f3;text-align:left;font-size:0.9rem}
    th{background:#f7f9fa;color:#555;font-weight:700}
    tr:hover td{background:#fbfdff}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <img src="bbkksby.png" alt="logo">
    <a href="landing-tpp.html">+ Input Data</a>
  </div>

    <div class="page-wrapper">
        <nav class="sidebar">
            <h2>SANITASI <br> LINGKUNGAN</h2>
            <ul>
                <li>
                    <a href="dashboard.html">
                        <i class="fas fa-chart-pie"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a href="dashboard-ttu.html">
                        <i class="fas fa-school"></i> Tempat Fasilitas Umum
                    </a>
                </li>
                <li>
                    <a href="dashboard_air.html">
                        <i class="fas fa-tint"></i> Penyediaan Air Bersih
                    </a>
                </li>
                <li>
                    <a href="dashboard-tpp.html">
                        <i class="fas fa-utensils"></i> Pengelolaan Pangan
                    </a>
                </li>
                <li>
                    <a href="dashboard-sertifikat.html">
                        <i class="fas fa-file-alt"></i> Penerbitan Sertifikat
                    </a>
                </li>
                <li>
                    <a href="logout.html">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </li>
            </ul>
        </nav>

    <!-- Main -->
    <main class="main">
      <h2 class="main-title">DASHBOARD PENGELOLAAN PANGAN (TPP)</h2>

      <!-- Filter -->
      <section class="filter-section">
        <div class="filter-group">
          <label for="start_date">Dari Tanggal</label>
          <input type="date" id="start_date">
        </div>
        <div class="filter-group">
          <label for="end_date">Hingga Tanggal</label>
          <input type="date" id="end_date">
        </div>
        <div class="filter-group">
          <label for="wilayah_kerja">Wilayah Kerja</label>
          <select id="wilayah_kerja">
            <option value="">Semua Wilayah</option>
            <option>Bandara Internasional Juanda Surabaya</option>
            <option>Asrama Haji Sukolilo Surabaya</option>
            <option>Pelabuhan Tanjung Perak</option>
            <option>Pelabuhan Gresik</option>
            <option>Pelabuhan Tuban</option>
            <option>Pelabuhan Kalianget</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn" id="applyFiltersBtn">Terapkan Filter</button>
          <button class="btn secondary" id="resetFiltersBtn">Reset</button>
        </div>
      </section>

    <!-- KPI -->
    <section class="kpi-cards">
    <div class="kpi"><div class="title">Total Pemeriksaan TPP</div><div class="value" id="kpi-total">0</div></div>

    <!-- Inspeksi -->
    <div class="kpi"><div class="title">Inspeksi MS</div><div class="value" id="kpi-inspeksi-ms">0</div></div>
    <div class="kpi"><div class="title">Inspeksi TMS</div><div class="value" id="kpi-inspeksi-tms">0</div></div>
    <div class="kpi"><div class="title">Inspeksi Tidak Ada Catatan</div><div class="value" id="kpi-inspeksi-nodata">0</div></div>

    <!-- Orgonoleptik -->
    <div class="kpi"><div class="title">Orgonoleptik MS</div><div class="value" id="kpi-org-ms">0</div></div>
    <div class="kpi"><div class="title">Orgonoleptik TMS</div><div class="value" id="kpi-org-tms">0</div></div>

    <!-- Mikrobiologi -->
    <div class="kpi"><div class="title">Mikrobiologi MS</div><div class="value" id="kpi-mikro-ms">0</div></div>
    <div class="kpi"><div class="title">Mikrobiologi TMS</div><div class="value" id="kpi-mikro-tms">0</div></div>

    <!-- Kimiawi -->
    <div class="kpi"><div class="title">Kimiawi MS</div><div class="value" id="kpi-kimia-ms">0</div></div>
    <div class="kpi"><div class="title">Kimiawi TMS</div><div class="value" id="kpi-kimia-tms">0</div></div>

    <!-- Usap Alat -->
    <div class="kpi"><div class="title">Usap Alat MS</div><div class="value" id="kpi-usap-ms">0</div></div>
    <div class="kpi"><div class="title">Usap Alat TMS</div><div class="value" id="kpi-usap-tms">0</div></div>
    </section>


      <!-- Charts -->
      <section class="chart-section">
        <div class="chart-card">
          <h3>Distribusi Hasil Pemeriksaan</h3>
          <div class="chart-canvas"><canvas id="pieChart"></canvas></div>
        </div>
        <div class="chart-card">
          <h3>Jumlah Pemeriksaan per Wilayah</h3>
          <div class="chart-canvas"><canvas id="barChart"></canvas></div>
        </div>
        <div class="chart-card chart-full">
          <h3>Tren Bulanan Pemeriksaan TPP</h3>
          <div class="chart-canvas"><canvas id="lineChart"></canvas></div>
        </div>
      </section>

      <!-- Table -->
      <section class="table-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <h3 style="margin:0;color:var(--accent)">Data Terbaru</h3>
          <button class="btn" id="downloadExcelBtn">
            <i class="fas fa-file-excel"></i> Download Excel
          </button>
        </div>

        <div style="overflow:auto">
          <table id="recent-table">

              <tr>
                <th>Nama TPP</th><th>Lokasi</th><th>Wilayah</th>
                <th>Inspeksi</th><th>Orgonoleptik</th><th>Mikrobiologi</th>
                <th>Kimiawi</th><th>Usap Alat</th><th>Tanggal</th>
                <th>Temuan</th><th>Rekomendasi</th><th>Keterangan</th>
              </tr>
            </thead>
            <tbody id="recent-table-body">
              <tr><td colspan="12" style="text-align:center;padding:18px">Memuat data...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    let pieChart, barChart, lineChart;

    document.addEventListener("DOMContentLoaded", () => {
      initCharts();
      attachHandlers();
      fetchTPPData();
    });

    function initCharts(){
      pieChart = new Chart(document.getElementById("pieChart"), {
        type: 'pie',
        data: {labels:['MS','TMS'], datasets:[{data:[0,0], backgroundColor:['#4caf50','#f44336']}]},
        options:{responsive:true,maintainAspectRatio:false}
      });
      barChart = new Chart(document.getElementById("barChart"), {
        type: 'bar',
        data: {labels:[], datasets:[{label:'Jumlah Pemeriksaan', data:[], backgroundColor:'#2196f3'}]},
        options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
      });
      lineChart = new Chart(document.getElementById("lineChart"), {
        type: 'line',
        data: {labels:[], datasets:[{label:'TPP per Bulan', data:[], borderColor:'#ff9800', fill:false}]},
        options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
      });
    }

    function attachHandlers(){
      document.getElementById("applyFiltersBtn").addEventListener("click", fetchTPPData);
      document.getElementById("resetFiltersBtn").addEventListener("click", () => {
        document.getElementById("wilayah_kerja").value = '';
        document.getElementById("start_date").value = '';
        document.getElementById("end_date").value = '';
        fetchTPPData();
      });
    }
          // Tombol Download Excel
    document.getElementById("downloadExcelBtn").addEventListener("click", () => {
      const start = document.getElementById("start_date").value;
      const end = document.getElementById("end_date").value;
      const wilayah = document.getElementById("wilayah_kerja").value;
      const params = new URLSearchParams({
        start_date: start,
        end_date: end,
        wilayah_kerja: wilayah,
        download: 1
      });
      // ganti 'get_tpp_data.php' jika nama file PHP-mu beda
      window.open(`get_tpp_data.php?${params.toString()}`, "_blank");
    });



    async function fetchTPPData(){
      const start = document.getElementById("start_date").value;
      const end = document.getElementById("end_date").value;
      const wilayah = document.getElementById("wilayah_kerja").value;

      const url = `get_tpp_data.php?start_date=${start}&end_date=${end}&wilayah_kerja=${encodeURIComponent(wilayah)}`;
      const res = await fetch(url);
      const data = await res.json();

      // Update KPI
        // Update KPI Total
        document.getElementById("kpi-total").textContent = data.kpi.total ?? 0;

        // Inspeksi
        document.getElementById("kpi-inspeksi-ms").textContent = data.kpi.inspeksi?.ms ?? 0;
        document.getElementById("kpi-inspeksi-tms").textContent = data.kpi.inspeksi?.tms ?? 0;

        // Orgonoleptik
        document.getElementById("kpi-org-ms").textContent = data.kpi.orgonoleptik?.ms ?? 0;
        document.getElementById("kpi-org-tms").textContent = data.kpi.orgonoleptik?.tms ?? 0;

        // Mikrobiologi
        document.getElementById("kpi-mikro-ms").textContent = data.kpi.mikrobiologi?.ms ?? 0;
        document.getElementById("kpi-mikro-tms").textContent = data.kpi.mikrobiologi?.tms ?? 0;

        // Kimiawi
        document.getElementById("kpi-kimia-ms").textContent = data.kpi.kimiawi?.ms ?? 0;
        document.getElementById("kpi-kimia-tms").textContent = data.kpi.kimiawi?.tms ?? 0;

        // Usap Alat
        document.getElementById("kpi-usap-ms").textContent = data.kpi.usap_alat?.ms ?? 0;
        document.getElementById("kpi-usap-tms").textContent = data.kpi.usap_alat?.tms ?? 0;


      // Update Pie
        // Ambil summary untuk pie chart
      // Update Pie
      pieChart.data.datasets[0].data = [
        data.kpi.summary.ms ?? 0,
        data.kpi.summary.tms ?? 0
      ];
      pieChart.update();




      // Update Bar
      barChart.data.labels = data.wilayah.map(w => w.wilayah_kerja);
      barChart.data.datasets[0].data = data.wilayah.map(w => w.count);
      barChart.update();

      // Update Line
      lineChart.data.labels = data.trend.map(t => t.label);
      lineChart.data.datasets[0].data = data.trend.map(t => t.count);
      lineChart.update();

      // Update Table
      const tbody = document.getElementById("recent-table-body");
      tbody.innerHTML = "";
      if(data.recent && data.recent.length > 0){
        data.recent.forEach(r=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.nama ?? ''}</td>
            <td>${r.lokasi ?? ''}</td>
            <td>${r.wilayah ?? ''}</td>
            <td>${r.inspeksi ?? ''}</td>
            <td>${r.orgonoleptik ?? ''}</td>
            <td>${r.mikrobiologi ?? ''}</td>
            <td>${r.kimiawi ?? ''}</td>
            <td>${r.usap_alat ?? ''}</td>
            <td>${r.tanggal ?? ''}</td>
            <td>${r.temuan ?? ''}</td>
            <td>${r.rekomendasi ?? ''}</td>
            <td>${r.keterangan ?? ''}</td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;padding:18px">Tidak ada data</td></tr>`;
      }
    }
  </script>
</body>
</html>