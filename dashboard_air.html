<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Air Bersih</title>

  <!-- Icon & Chart.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>


  <style>
    :root{
      --bg:#f4f7f6;
      --accent:#312E5C;
      --accent-2:#6a62a7;
      --card:#ffffff;
      --muted:#6b6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#222}
    .header{background:var(--accent);color:#fff;padding:14px 24px;display:flex;align-items:center;gap:12px}
    .header h1{margin:0;font-size:1.2rem;font-weight:700}
    .page-wrapper{display:flex;min-height:calc(100vh - 72px)}

    /* sidebar */
          /* =================================
           3. SIDEBAR NAVIGASI (STANDAR)
           ================================= */
        .sidebar {
            width: 260px;
            background-color: #312E5C;
            color: white;
            min-height: calc(100vh - 75px);
            padding: 20px;
            box-sizing: border-box;
        }

        .sidebar h2 {
            text-align: center;
            border-bottom: 1px solid #6a62a7;
            padding-bottom: 15px;
            margin-top: 0;
            font-size: 1.2em;
        }

        .sidebar ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            color: #e0e0e0;
            text-decoration: none;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: background-color 0.3s;
        }

        .sidebar ul li a i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }

        .sidebar ul li a:hover {
            background-color: #4B447A;
        }

        .sidebar ul li a.active {
            background-color: #6a62a7;
            font-weight: bold;
        }
        
    .main{flex:1;padding:22px}
    .main-title{text-align:center;color:var(--accent);font-size:1.6rem;margin:6px 0 18px 0}

    /* filter */
    .filter-section{display:flex;flex-wrap:wrap;gap:12px;align-items:end;background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:18px}
    .filter-group{min-width:160px;flex:1}
    label{display:block;font-weight:600;margin-bottom:6px;color:var(--muted);font-size:0.9rem}
    select,input[type=date]{width:100%;padding:10px;border-radius:8px;border:1px solid #dfe6ea;background:#f7fbff}
    .btn{padding:10px 16px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#6a62a7}

    /* KPI */
    .kpi-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:18px}
    .kpi{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:6px}
    .kpi .title{font-size:0.95rem;color:var(--muted)}
    .kpi .value{font-size:1.6rem;color:var(--accent);font-weight:800}

   /* charts */
    .chart-section{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px}
    .chart-card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);min-height:220px}
    .chart-card h3{margin:0 0 8px 0;color:var(--accent);font-size:1rem}
    .chart-canvas{position:relative;height:220px}
    .chart-full{grid-column:1/-1}

    /* table */
    .table-card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef2f3;text-align:left;font-size:0.9rem}
    th{background:#f7f9fa;color:#555;font-weight:700}
    tr:hover td{background:#fbfdff}
  </style>
</head>
<body>
<div class="header">
  <img src="bbkksby.png" alt="logo" style="height:45px;">
  <div style="margin-left:auto;">
    <a href="landing-air.html" 
       style="background:#6a62a7;color:white;padding:8px 14px;border-radius:6px;
              text-decoration:none;font-weight:600;display:inline-block;">
      + Input Data
    </a>
  </div>
</div>


    <div class="page-wrapper">
        <nav class="sidebar">
            <h2>SANITASI <br> LINGKUNGAN</h2>
            <ul>
                <li>
                    <a href="dashboard.html">
                        <i class="fas fa-chart-pie"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a href="dashboard-ttu.html">
                        <i class="fas fa-school"></i> Tempat Fasilitas Umum
                    </a>
                </li>
                <li>
                    <a href="dashboard_air.html">
                        <i class="fas fa-tint"></i> Penyediaan Air Bersih
                    </a>
                </li>
                <li>
                    <a href="dashboard-tpp.html">
                        <i class="fas fa-utensils"></i> Pengelolaan Pangan
                    </a>
                </li>
                <li>
                    <a href="dashboard-sertifikat.html">
                        <i class="fas fa-file-alt"></i> Penerbitan Sertifikat
                    </a>
                </li>
                <li>
                    <a href="logout.html">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </li>
            </ul>
        </nav>

  <main class="main">
    <h2 class="main-title">DASHBOARD AIR BERSIH</h2>

    <!-- Filter -->
    <section class="filter-section">
      <div class="filter-group">
        <label for="start_date">Dari Tanggal</label>
        <input type="date" id="start_date">
      </div>
      <div class="filter-group">
        <label for="end_date">Hingga Tanggal</label>
        <input type="date" id="end_date">
      </div>
      <div class="filter-group">
        <label for="wilayah_kerja">Wilayah Kerja</label>
        <select id="wilayah_kerja">
          <option value="">Semua Wilayah</option>
          <option>Bandara Internasional Juanda Surabaya</option>
          <option>Asrama Haji Sukolilo Surabaya</option>
          <option>Pelabuhan Tanjung Perak</option>
          <option>Pelabuhan Gresik</option>
          <option>Pelabuhan Tuban</option>
          <option>Pelabuhan Kalianget</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn" id="applyFiltersBtn">Terapkan Filter</button>
        <button class="btn secondary" id="resetFiltersBtn">Reset</button>
      </div>
    </section>

    <!-- KPI -->
    <section class="kpi-cards">
      <div class="kpi"><div class="title">Total Pemeriksaan Air</div><div class="value" id="kpi-total">0</div></div>
      <div class="kpi"><div class="title">Hasil Sarana MS</div><div class="value" id="kpi-sarana-ms">0</div></div>
      <div class="kpi"><div class="title">Hasil Sarana TMS</div><div class="value" id="kpi-sarana-tms">0</div></div>
      <div class="kpi"><div class="title">Bakteriologis MS</div><div class="value" id="kpi-bakteri-ms">0</div></div>
      <div class="kpi"><div class="title">Bakteriologis TMS</div><div class="value" id="kpi-bakteri-tms">0</div></div>
      <div class="kpi"><div class="title">Kimia Lengkap MS</div><div class="value" id="kpi-kimia-ms">0</div></div>
      <div class="kpi"><div class="title">Kimia Lengkap TMS</div><div class="value" id="kpi-kimia-tms">0</div></div>
    </section>

    <!-- Charts -->
    <section class="chart-section">
      <div class="chart-card">
        <h3>Distribusi Hasil (MS vs TMS)</h3>
        <div class="chart-canvas"><canvas id="pieChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Jumlah Pemeriksaan per Wilayah</h3>
        <div class="chart-canvas"><canvas id="barChart"></canvas></div>
      </div>
      <div class="chart-card chart-full">
        <h3>Tren Bulanan Pemeriksaan Air</h3>
        <div class="chart-canvas"><canvas id="lineChart"></canvas></div>
      </div>
    </section>

    <!-- Top 5 -->
    <section class="table-card">
      <h3 style="margin:0 0 10px 0;color:var(--accent)">Top 5 Lokasi pH & Chlor</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px">
        <div>
          <h4 style="margin:0 0 6px;color:var(--muted)">pH Tertinggi</h4>
          <table id="top-ph-good"><thead><tr><th>Lokasi</th><th>pH</th></tr></thead><tbody></tbody></table>
        </div>
        <div>
          <h4 style="margin:0 0 6px;color:var(--muted)">pH Terendah</h4>
          <table id="top-ph-bad"><thead><tr><th>Lokasi</th><th>pH</th></tr></thead><tbody></tbody></table>
        </div>
        <div>
          <h4 style="margin:0 0 6px;color:var(--muted)">Chlor Tertinggi</h4>
          <table id="top-chlor-good"><thead><tr><th>Lokasi</th><th>Chlor</th></tr></thead><tbody></tbody></table>
        </div>
        <div>
          <h4 style="margin:0 0 6px;color:var(--muted)">Chlor Terendah</h4>
          <table id="top-chlor-bad"><thead><tr><th>Lokasi</th><th>Chlor</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- Tabel Data Terbaru -->
    <section class="table-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h3 style="margin:0;color:var(--accent)">Data Terbaru</h3>
        <button class="btn secondary" id="downloadExcelBtn">
          <i class="fa fa-download"></i> Download Excel
        </button>
      </div>


      <div style="overflow:auto">
        <table id="recent-table">
          <thead>
            <tr>
              <th>Lokasi</th>
              <th>Wilayah</th>
              <th>Hasil Sarana</th>
              <th>Hasil Bakteriologis</th>
              <th>Hasil Kimia Lengkap</th>
              <th>pH</th>
              <th>Sisa Chlor</th>
              <th>Tanggal</th>
              <th>Rekomendasi</th>
            </tr>
          </thead>
          <tbody id="recent-table-body">
            <tr><td colspan="9" style="text-align:center;padding:18px">Memuat data...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<script>
let pieChart, barChart, lineChart;

document.addEventListener("DOMContentLoaded", () => {
  initCharts();
  attachHandlers();
  fetchAirData();
});

function initCharts(){
  pieChart = new Chart(document.getElementById("pieChart"), {
    type: 'pie',
    data: {labels:['MS','TMS'], datasets:[{data:[0,0], backgroundColor:['#4caf50','#f44336']}]},
    options:{responsive:true,maintainAspectRatio:false}
  });
  barChart = new Chart(document.getElementById("barChart"), {
    type: 'bar',
    data: {labels:[], datasets:[{label:'Jumlah Pemeriksaan', data:[], backgroundColor:'#2196f3'}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
  });
  lineChart = new Chart(document.getElementById("lineChart"), {
    type: 'line',
    data: {labels:[], datasets:[{label:'Air Bersih per Bulan', data:[], borderColor:'#ff9800', fill:false}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
  });
}

function attachHandlers(){
  document.getElementById("applyFiltersBtn").addEventListener("click", fetchAirData);
  document.getElementById("resetFiltersBtn").addEventListener("click", () => {
    document.getElementById("wilayah_kerja").value = '';
    document.getElementById("start_date").value = '';
    document.getElementById("end_date").value = '';
    fetchAirData();
  });

  // 👉 Tombol Download Excel
  document.getElementById("downloadExcelBtn").addEventListener("click", () => {
    const start = document.getElementById("start_date").value;
    const end   = document.getElementById("end_date").value;
    const wilayah = document.getElementById("wilayah_kerja").value;
    const params = new URLSearchParams({ start_date: start, end_date: end, wilayah_kerja: wilayah });
    window.open(`download_air_data.php?${params.toString()}`, "_blank");
  });
}


async function fetchAirData(){
  const start = document.getElementById("start_date").value;
  const end   = document.getElementById("end_date").value;
  const wilayah = document.getElementById("wilayah_kerja").value;

  const params = new URLSearchParams({ start_date: start, end_date: end, wilayah_kerja: wilayah });
  try {
    const res = await fetch(`get_air_data.php?${params.toString()}`);
    const data = await res.json();

    // KPI
    document.getElementById("kpi-total").textContent = data.kpi.total ?? 0;
    document.getElementById("kpi-sarana-ms").textContent = data.kpi.sarana_ms ?? 0;
    document.getElementById("kpi-sarana-tms").textContent = data.kpi.sarana_tms ?? 0;
    document.getElementById("kpi-bakteri-ms").textContent = data.kpi.bakteri_ms ?? 0;
    document.getElementById("kpi-bakteri-tms").textContent = data.kpi.bakteri_tms ?? 0;
    document.getElementById("kpi-kimia-ms").textContent = data.kpi.kimia_ms ?? 0;
    document.getElementById("kpi-kimia-tms").textContent = data.kpi.kimia_tms ?? 0;

    // Pie
    pieChart.data.datasets[0].data = [data.kpi.ms ?? 0, data.kpi.tms ?? 0];
    pieChart.update();

    // Bar
    barChart.data.labels = data.wilayah.map(i => i.wilayah_kerja);
    barChart.data.datasets[0].data = data.wilayah.map(i => i.count);
    barChart.update();

    // Line - total pemeriksaan
    lineChart.data.labels = data.trend.map(i => i.label);
    lineChart.data.datasets[0].data = data.trend.map(i => i.count);
    lineChart.update();

    // Top 5 pH good/bad
    const phGoodBody = document.querySelector("#top-ph-good tbody");
    phGoodBody.innerHTML = "";
    data.top_ph_good.forEach(r => {
      phGoodBody.innerHTML += `<tr><td>${r.lokasi}</td><td>${r.ph}</td></tr>`;
    });

    const phBadBody = document.querySelector("#top-ph-bad tbody");
    phBadBody.innerHTML = "";
    data.top_ph_bad.forEach(r => {
      phBadBody.innerHTML += `<tr><td>${r.lokasi}</td><td>${r.ph}</td></tr>`;
    });

    // Top 5 Chlor good/bad
    const chlorGoodBody = document.querySelector("#top-chlor-good tbody");
    chlorGoodBody.innerHTML = "";
    data.top_chlor_good.forEach(r => {
      chlorGoodBody.innerHTML += `<tr><td>${r.lokasi}</td><td>${r.chlor}</td></tr>`;
    });

    const chlorBadBody = document.querySelector("#top-chlor-bad tbody");
    chlorBadBody.innerHTML = "";
    data.top_chlor_bad.forEach(r => {
      chlorBadBody.innerHTML += `<tr><td>${r.lokasi}</td><td>${r.chlor}</td></tr>`;
    });

    // Table Data Terbaru
    const tbody = document.getElementById("recent-table-body");
    tbody.innerHTML = "";
    if(data.recent.length === 0){
      tbody.innerHTML = "<tr><td colspan='9'>Tidak ada data</td></tr>";
    } else {
      data.recent.forEach(e => {
        tbody.innerHTML += `<tr>
          <td>${e.nama}</td>
          <td>${e.wilayah}</td>
          <td>${e.hasil_sarana}</td>
          <td>${e.hasil_bakteri}</td>
          <td>${e.hasil_kimia}</td>
          <td>${e.ph}</td>
          <td>${e.chlor}</td>
          <td>${e.tanggal}</td>
          <td>${e.rekomendasi}</td>
        </tr>`;
      });
    }
  } catch (err) {
    console.error("Gagal ambil data:", err);
    document.getElementById("recent-table-body").innerHTML = "<tr><td colspan='9' style='color:red'>Error load data</td></tr>";
  }
}
</script>
</body>
</html>